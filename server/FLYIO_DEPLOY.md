# Fly.io éƒ¨ç½²å®Œæ•´æŒ‡å—

## Fly.io ç®€ä»‹

Fly.io æ˜¯ä¸€ä¸ªå…¨çƒè¾¹ç¼˜éƒ¨ç½²å¹³å°ï¼Œå°†åº”ç”¨éƒ¨ç½²åˆ°å…¨çƒå¤šä¸ªæ•°æ®ä¸­å¿ƒï¼Œè®¿é—®é€Ÿåº¦å¿«ã€‚

**ä¼˜ç‚¹**ï¼š
- âœ… å…è´¹é¢åº¦å……è¶³ï¼ˆ3ä¸ªå…±äº«CPUï¼Œ160GBæµé‡/æœˆï¼‰
- âœ… å…¨çƒè¾¹ç¼˜éƒ¨ç½²ï¼ˆé€Ÿåº¦å¿«ï¼‰
- âœ… æ— ä¼‘çœ ï¼ŒæŒç»­è¿è¡Œ
- âœ… è‡ªåŠ¨ HTTPS
- âœ… åŠŸèƒ½å¼ºå¤§

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ CLI å·¥å…·ï¼ˆç›¸å¯¹å¤æ‚ï¼‰
- âš ï¸ é…ç½®æ­¥éª¤è¾ƒå¤š

---

## éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå®‰è£… Fly CLI

#### Windows (PowerShell)

```powershell
powershell -Command "iwr https://fly.io/install.ps1 -useb | iex"
```

#### macOS/Linux

```bash
curl -L https://fly.io/install.sh | sh
```

#### éªŒè¯å®‰è£…

```bash
fly version
```

åº”è¯¥æ˜¾ç¤º Fly CLI ç‰ˆæœ¬å·ã€‚

### ç¬¬äºŒæ­¥ï¼šç™»å½• Fly.io

```bash
fly auth login
```

è¿™ä¼šæ‰“å¼€æµè§ˆå™¨ï¼Œä½¿ç”¨ GitHub è´¦å·ç™»å½•ã€‚

### ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–é¡¹ç›®

1. **è¿›å…¥ server ç›®å½•**

```bash
cd server
```

2. **åˆå§‹åŒ– Fly.io åº”ç”¨**

```bash
fly launch
```

è¿™ä¼šäº¤äº’å¼åœ°è¯¢é—®ä¸€äº›é—®é¢˜ï¼š

- **App Name**: è¾“å…¥åº”ç”¨åç§°ï¼ˆä¾‹å¦‚ï¼š`pic4pick-backend`ï¼‰
  - å¦‚æœåç§°å·²è¢«å ç”¨ï¼ŒFly.io ä¼šæç¤ºæ‚¨é€‰æ‹©å…¶ä»–åç§°
- **Region**: é€‰æ‹©éƒ¨ç½²åŒºåŸŸï¼ˆå»ºè®®é€‰æ‹©ç¦»æ‚¨æœ€è¿‘çš„ï¼Œä¾‹å¦‚ï¼š`hkg` é¦™æ¸¯ï¼‰
- **Postgres**: é€‰æ‹© `n`ï¼ˆæˆ‘ä»¬ä½¿ç”¨ Supabaseï¼Œä¸éœ€è¦ Fly.io çš„æ•°æ®åº“ï¼‰
- **Redis**: é€‰æ‹© `n`ï¼ˆä¸éœ€è¦ï¼‰
- **Deploy now**: é€‰æ‹© `n`ï¼ˆå…ˆé…ç½®ç¯å¢ƒå˜é‡å†éƒ¨ç½²ï¼‰

### ç¬¬å››æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

Fly.io ä½¿ç”¨ `fly secrets set` å‘½ä»¤è®¾ç½®ç¯å¢ƒå˜é‡ã€‚

```bash
# è®¾ç½®æœåŠ¡å™¨é…ç½®
fly secrets set PORT=3002
fly secrets set NODE_ENV=production
fly secrets set CORS_ORIGIN=https://pic.rlzhao.com

# è®¾ç½®é˜¿é‡Œäº‘ OSS é…ç½®
fly secrets set ALIYUN_OSS_REGION=cn-beijing
fly secrets set ALIYUN_OSS_BUCKET=pic4pick
fly secrets set ALIYUN_OSS_ACCESS_KEY_ID=ä½ çš„AccessKey ID
fly secrets set ALIYUN_OSS_ACCESS_KEY_SECRET=ä½ çš„AccessKey Secret
```

**é‡è¦æç¤º**ï¼š
- å°† `CORS_ORIGIN` æ›¿æ¢ä¸ºæ‚¨çš„ GitHub Pages åŸŸå
- å°† OSS é…ç½®æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å€¼
- æ¯æ¬¡è®¾ç½®ä¸€ä¸ªå˜é‡ï¼Œæˆ–ä½¿ç”¨å¤šä¸ªå‘½ä»¤

### ç¬¬äº”æ­¥ï¼šæ£€æŸ¥ fly.toml é…ç½®

Fly.io ä¼šåœ¨ `server` ç›®å½•ä¸‹åˆ›å»º `fly.toml` é…ç½®æ–‡ä»¶ã€‚æ£€æŸ¥å¹¶ç¡®ä¿é…ç½®æ­£ç¡®ï¼š

```toml
app = "your-app-name"
primary_region = "hkg"  # æˆ–æ‚¨é€‰æ‹©çš„åŒºåŸŸ

[build]

[env]
  PORT = "3002"

[http_service]
  internal_port = 3002
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]

[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 256
```

**é‡è¦é…ç½®**ï¼š
- `internal_port = 3002`ï¼šç¡®ä¿ä¸æ‚¨çš„æœåŠ¡å™¨ç«¯å£ä¸€è‡´
- `auto_stop_machines = false`ï¼šé˜²æ­¢åº”ç”¨ä¼‘çœ 
- `min_machines_running = 1`ï¼šä¿æŒè‡³å°‘ä¸€ä¸ªå®ä¾‹è¿è¡Œ

### ç¬¬å…­æ­¥ï¼šéƒ¨ç½²åº”ç”¨

```bash
fly deploy
```

è¿™ä¼šï¼š
1. æ„å»º Docker é•œåƒ
2. ä¸Šä¼ åˆ° Fly.io
3. éƒ¨ç½²åº”ç”¨
4. æ˜¾ç¤ºéƒ¨ç½² URL

ç­‰å¾…éƒ¨ç½²å®Œæˆï¼ˆé€šå¸¸ 3-5 åˆ†é’Ÿï¼‰ã€‚

### ç¬¬ä¸ƒæ­¥ï¼šè·å–åç«¯ URL

éƒ¨ç½²å®Œæˆåï¼ŒFly.io ä¼šæ˜¾ç¤ºåº”ç”¨ URLï¼š

```
https://your-app-name.fly.dev
```

æ‚¨çš„åç«¯ API åœ°å€ï¼š
```
https://your-app-name.fly.dev/api/upload/oss
```

å¥åº·æ£€æŸ¥åœ°å€ï¼š
```
https://your-app-name.fly.dev/api/health
```

### ç¬¬å…«æ­¥ï¼šæµ‹è¯•åç«¯

1. **æµ‹è¯•å¥åº·æ£€æŸ¥**

åœ¨æµè§ˆå™¨è®¿é—®ï¼š
```
https://your-app-name.fly.dev/api/health
```

åº”è¯¥è¿”å›ï¼š`{"status":"ok"}`

2. **æŸ¥çœ‹æ—¥å¿—**

```bash
fly logs
```

åº”è¯¥çœ‹åˆ°ï¼š
```
âœ… é˜¿é‡Œäº‘ OSS å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
ğŸš€ æœåŠ¡å™¨è¿è¡Œåœ¨ http://0.0.0.0:3002
```

---

## é…ç½®å‰ç«¯è¿æ¥åç«¯

### æ–¹å¼ 1ï¼šé€šè¿‡ç®¡ç†é¢æ¿é…ç½®ï¼ˆæ¨èï¼‰

1. **è®¿é—®æ‚¨çš„ GitHub Pages ç½‘ç«™**
   - æ‰“å¼€ç®¡ç†é¢æ¿

2. **é…ç½®åç«¯ URL**
   - åˆ‡æ¢åˆ°"é…ç½®"æ ‡ç­¾é¡µ
   - æ‰¾åˆ°"é˜¿é‡Œäº‘ OSS åç«¯é…ç½®"
   - è¾“å…¥ï¼š`https://your-app-name.fly.dev/api/upload/oss`
   - ç‚¹å‡»"ä¿å­˜é…ç½®"
   - åˆ·æ–°é¡µé¢

### æ–¹å¼ 2ï¼šé€šè¿‡æµè§ˆå™¨æ§åˆ¶å°

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
localStorage.setItem('aliyun_oss_backend_url', 'https://your-app-name.fly.dev/api/upload/oss');
location.reload();
```

---

## å¸¸ç”¨ Fly.io å‘½ä»¤

### æŸ¥çœ‹åº”ç”¨çŠ¶æ€

```bash
fly status
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æ—¥å¿—
fly logs

# æŸ¥çœ‹æœ€è¿‘æ—¥å¿—
fly logs --limit 100
```

### æŸ¥çœ‹ç¯å¢ƒå˜é‡

```bash
fly secrets list
```

### æ›´æ–°ç¯å¢ƒå˜é‡

```bash
fly secrets set KEY=value
```

### åˆ é™¤ç¯å¢ƒå˜é‡

```bash
fly secrets unset KEY
```

### é‡å¯åº”ç”¨

```bash
fly apps restart your-app-name
```

### æŸ¥çœ‹åº”ç”¨ä¿¡æ¯

```bash
fly info
```

### SSH è¿æ¥åˆ°åº”ç”¨

```bash
fly ssh console
```

---

## éªŒè¯éƒ¨ç½²

### 1. æµ‹è¯•ä¸Šä¼ åŠŸèƒ½

1. æ‰“å¼€ç®¡ç†é¢æ¿
2. ä¸Šä¼ ä¸€å¼ æµ‹è¯•å›¾ç‰‡
3. æ£€æŸ¥ï¼š
   - âœ… ä¸Šä¼ è¿›åº¦æ¡æ­£å¸¸æ˜¾ç¤º
   - âœ… ä¸Šä¼ æˆåŠŸåæ˜¾ç¤º OSS URL
   - âœ… æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯

### 2. æ£€æŸ¥åç«¯æ—¥å¿—

```bash
fly logs
```

ç¡®è®¤çœ‹åˆ°ï¼š
- ä¸Šä¼ è¯·æ±‚æ—¥å¿—
- OSS ä¸Šä¼ æˆåŠŸæ—¥å¿—

### 3. æ£€æŸ¥ OSS

è®¿é—®é˜¿é‡Œäº‘ OSS æ§åˆ¶å°ï¼š
- ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ 

### 4. æ£€æŸ¥æ•°æ®åº“

è®¿é—® Supabase æ§åˆ¶å°ï¼š
- ç¡®è®¤æ–°è®°å½•å·²åˆ›å»º

---

## å¸¸è§é—®é¢˜

### Q: fly launch å¤±è´¥ï¼Ÿ

1. **æ£€æŸ¥æ˜¯å¦å·²ç™»å½•**
   ```bash
   fly auth whoami
   ```

2. **æ£€æŸ¥ç½‘ç»œè¿æ¥**
   - ç¡®ä¿å¯ä»¥è®¿é—® fly.io

3. **æ£€æŸ¥åº”ç”¨åç§°**
   - åº”ç”¨åç§°å¿…é¡»å…¨å±€å”¯ä¸€
   - å¦‚æœè¢«å ç”¨ï¼Œé€‰æ‹©å…¶ä»–åç§°

### Q: éƒ¨ç½²å¤±è´¥ï¼Ÿ

1. **æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—**
   ```bash
   fly logs
   ```

2. **æ£€æŸ¥ fly.toml é…ç½®**
   - ç¡®è®¤ `internal_port` æ­£ç¡®
   - ç¡®è®¤ `build` é…ç½®æ­£ç¡®

3. **æ£€æŸ¥ç¯å¢ƒå˜é‡**
   ```bash
   fly secrets list
   ```

### Q: ç¯å¢ƒå˜é‡ä¸ç”Ÿæ•ˆï¼Ÿ

1. **é‡æ–°éƒ¨ç½²**
   ```bash
   fly deploy
   ```

2. **æ£€æŸ¥å˜é‡å**
   - ç¡®è®¤å˜é‡åå®Œå…¨æ­£ç¡®
   - ç¡®è®¤æ²¡æœ‰å¤šä½™çš„ç©ºæ ¼

### Q: CORS é”™è¯¯ï¼Ÿ

1. **æ£€æŸ¥ CORS_ORIGIN**
   ```bash
   fly secrets list
   ```
   - ç¡®è®¤è®¾ç½®ä¸ºå®Œæ•´çš„å‰ç«¯åŸŸåï¼ˆåŒ…æ‹¬ `https://`ï¼‰

2. **é‡æ–°éƒ¨ç½²**
   ```bash
   fly deploy
   ```

### Q: åº”ç”¨æ— æ³•è®¿é—®ï¼Ÿ

1. **æ£€æŸ¥åº”ç”¨çŠ¶æ€**
   ```bash
   fly status
   ```

2. **æ£€æŸ¥æ—¥å¿—**
   ```bash
   fly logs
   ```

3. **æ£€æŸ¥åŒºåŸŸ**
   - ç¡®è®¤åº”ç”¨å·²éƒ¨ç½²åˆ°æ­£ç¡®çš„åŒºåŸŸ

### Q: å¦‚ä½•æŸ¥çœ‹ä½¿ç”¨æƒ…å†µï¼Ÿ

```bash
fly dashboard
```

è¿™ä¼šæ‰“å¼€ Fly.io Dashboardï¼Œå¯ä»¥æŸ¥çœ‹ï¼š
- åº”ç”¨çŠ¶æ€
- ä½¿ç”¨æƒ…å†µ
- æ—¥å¿—
- è®¾ç½®

---

## æ›´æ–°ä»£ç 

### æ–¹å¼ 1ï¼šè‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. **æ¨é€ä»£ç åˆ° GitHub**
   ```bash
   git add .
   git commit -m "æ›´æ–°ä»£ç "
   git push
   ```

2. **æ‰‹åŠ¨è§¦å‘éƒ¨ç½²**
   ```bash
   cd server
   fly deploy
   ```

### æ–¹å¼ 2ï¼šä½¿ç”¨ GitHub Actionsï¼ˆå¯é€‰ï¼‰

å¯ä»¥é…ç½® GitHub Actions è‡ªåŠ¨éƒ¨ç½²åˆ° Fly.ioã€‚

---

## æ€§èƒ½ä¼˜åŒ–

### 1. é€‰æ‹©åˆé€‚åŒºåŸŸ

- é€‰æ‹©ç¦»ç”¨æˆ·æœ€è¿‘çš„åŒºåŸŸ
- ä¸­å›½ç”¨æˆ·å»ºè®®é€‰æ‹©ï¼š`hkg`ï¼ˆé¦™æ¸¯ï¼‰æˆ– `nrt`ï¼ˆä¸œäº¬ï¼‰

### 2. è°ƒæ•´èµ„æºé…ç½®

åœ¨ `fly.toml` ä¸­ï¼š

```toml
[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512  # å¢åŠ å†…å­˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

### 3. ä½¿ç”¨å¤šä¸ªåŒºåŸŸï¼ˆé«˜çº§ï¼‰

å¯ä»¥é…ç½®åº”ç”¨åœ¨å¤šä¸ªåŒºåŸŸè¿è¡Œï¼Œæé«˜å¯ç”¨æ€§ã€‚

---

## ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹ä½¿ç”¨æƒ…å†µ

```bash
fly dashboard
```

æˆ–è®¿é—®ï¼šhttps://fly.io/dashboard

### æŸ¥çœ‹æ—¥å¿—

```bash
fly logs
```

### ç›‘æ§åº”ç”¨

- Fly.io Dashboard æä¾›å®æ—¶ç›‘æ§
- å¯ä»¥æŸ¥çœ‹è¯·æ±‚æ•°ã€å“åº”æ—¶é—´ç­‰

---

## å®Œæˆï¼

éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„åç«¯æœåŠ¡å™¨åº”è¯¥ï¼š
- âœ… æ­£å¸¸è¿è¡Œåœ¨ Fly.io
- âœ… å…¨çƒè¾¹ç¼˜éƒ¨ç½²ï¼ˆè®¿é—®é€Ÿåº¦å¿«ï¼‰
- âœ… å¯ä»¥å¤„ç†ä¸Šä¼ è¯·æ±‚
- âœ… è‡ªåŠ¨ HTTPS
- âœ… æ— ä¼‘çœ ï¼ŒæŒç»­è¿è¡Œ

**ä¸‹ä¸€æ­¥**ï¼š
1. é…ç½®å‰ç«¯è¿æ¥åç«¯
2. æµ‹è¯•ä¸Šä¼ åŠŸèƒ½
3. å¼€å§‹ä½¿ç”¨ï¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ Fly.io æ–‡æ¡£ï¼šhttps://fly.io/docs

